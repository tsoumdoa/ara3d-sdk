<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>IFC Relations Graph — Pins, Filters, Hier Layout</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/elkjs@0.8.2/lib/elk.bundled.js"></script>
    <style>
        html, body {
            margin: 0;
            height: 100%;
        }

        svg {
            width: 100vw;
            height: 100vh;
            display: block;
            background: #fff;
        }

        /* Control panel */
        .panel {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 10;
            background: rgba(255,255,255,0.95);
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            max-width: 320px;
            user-select: none;
        }

            .panel h3 {
                margin: 0 0 8px;
                font-size: 14px;
            }

            .panel .row {
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 6px 0;
            }

            .panel label {
                font-size: 12px;
            }

            .panel input[type="range"] {
                width: 140px;
            }

            .panel .buttons {
                gap: 6px;
                flex-wrap: wrap;
            }

            .panel button, .panel select {
                font: inherit;
                padding: 4px 8px;
                border: 1px solid #ccc;
                border-radius: 8px;
                background: #f9f9f9;
                cursor: pointer;
            }

                .panel button:hover {
                    background: #f0f0f0;
                }

        /* Graph styles */
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .edge-label {
            font: 11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            fill: #111;
            pointer-events: none;
            user-select: none;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        /* Text halo for readability off-circle */
        .node-label, .node-count {
            fill: #fff;
            stroke: #222;
            stroke-width: 3px;
            paint-order: stroke fill;
            pointer-events: none;
            user-select: none;
            text-anchor: middle;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .node-label {
            font-size: 12px;
        }

        .node-count {
            font-size: 11px;
        }

        .pin-icon {
            font-size: 12px;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Control panel -->
    <div class="panel">
        <h3>IFC Graph Controls</h3>

        <div class="row">
            <label for="layoutMode"><strong>Layout:</strong></label>
            <select id="layoutMode">
                <option value="force">Force</option>
                <option value="hier">Hierarchical</option>
            </select>
        </div>

        <div class="row">
            <label><input type="checkbox" id="sizeByCount" checked> Size nodes by count</label>
        </div>
        <div class="row">
            <label><input type="checkbox" id="weightByCount" checked> Weight edges by count</label>
        </div>

        <div class="row">
            <label for="minNodeCount">Min node count: <span id="minNodeCountVal">0</span></label>
            <input type="range" id="minNodeCount" min="0" step="1" value="0" />
        </div>

        <div class="row">
            <label for="minEdgeCount">Min edge count: <span id="minEdgeCountVal">0</span></label>
            <input type="range" id="minEdgeCount" min="0" step="1" value="0" />
        </div>

        <div class="row buttons">
            <button id="fitBtn" title="Fit all visible nodes into view">Fit</button>
            <button id="freezeBtn" title="Stop/resume simulation">Freeze</button>
            <button id="unpinBtn" title="Unpin all user-pinned nodes">Unpin all</button>
        </div>
    </div>

    <svg></svg>

    <script>
        // ===== Example hard-coded data =====
        // 'nodes' defines per-node properties (color, count).
        // 'relations' maps SOURCE -> one or more { name: TARGET, count: edgeCount }.
        const data = {
            "nodes": {
                "IFCORGANIZATION": {
                    "color": "#0c08df",
                    "count": 2
                },
                "IFCAPPLICATION": {
                    "color": "#5b0126",
                    "count": 1
                },
                "IFCCARTESIANPOINT": {
                    "color": "#3e4434",
                    "count": 1050157
                },
                "IFCDIRECTION": {
                    "color": "#3c641a",
                    "count": 423
                },
                "IFCAXIS2PLACEMENT3D": {
                    "color": "#9d1f2e",
                    "count": 9232
                },
                "IFCPERSON": {
                    "color": "#345401",
                    "count": 1
                },
                "IFCPERSONANDORGANIZATION": {
                    "color": "#b13b19",
                    "count": 1
                },
                "IFCOWNERHISTORY": {
                    "color": "#3b4bca",
                    "count": 1
                },
                "IFCSIUNIT": {
                    "color": "#8e0112",
                    "count": 19
                },
                "IFCDIMENSIONALEXPONENTS": {
                    "color": "#146008",
                    "count": 1
                },
                "IFCMEASUREWITHUNIT": {
                    "color": "#af0522",
                    "count": 1
                },
                "IFCCONVERSIONBASEDUNIT": {
                    "color": "#111c53",
                    "count": 1
                },
                "IFCDERIVEDUNITELEMENT": {
                    "color": "#8d3259",
                    "count": 25
                },
                "IFCDERIVEDUNIT": {
                    "color": "#290f79",
                    "count": 9
                },
                "IFCUNITASSIGNMENT": {
                    "color": "#085f5b",
                    "count": 1
                },
                "IFCGEOMETRICREPRESENTATIONCONTEXT": {
                    "color": "#cf14c5",
                    "count": 1
                },
                "IFCGEOMETRICREPRESENTATIONSUBCONTEXT": {
                    "color": "#3e6392",
                    "count": 4
                },
                "IFCPROJECT": {
                    "color": "#312114",
                    "count": 1
                },
                "IFCLOCALPLACEMENT": {
                    "color": "#027072",
                    "count": 3876
                },
                "IFCSITE": {
                    "color": "#126654",
                    "count": 1
                },
                "IFCPROPERTYSINGLEVALUE": {
                    "color": "#3a56da",
                    "count": 28654
                },
                "IFCPROPERTYSET": {
                    "color": "#3e04f1",
                    "count": 20221
                },
                "IFCRELDEFINESBYPROPERTIES": {
                    "color": "#3146db",
                    "count": 18619
                },
                "IFCPOLYLINE": {
                    "color": "#0850ef",
                    "count": 2471
                },
                "IFCSHAPEREPRESENTATION": {
                    "color": "#bc4c70",
                    "count": 9151
                },
                "IFCAXIS2PLACEMENT2D": {
                    "color": "#438509",
                    "count": 3000
                },
                "IFCRECTANGLEPROFILEDEF": {
                    "color": "#83488c",
                    "count": 2698
                },
                "IFCEXTRUDEDAREASOLID": {
                    "color": "#ab1d84",
                    "count": 3189
                },
                "IFCCOLOURRGB": {
                    "color": "#736055",
                    "count": 60
                },
                "IFCSURFACESTYLERENDERING": {
                    "color": "#8212f6",
                    "count": 60
                },
                "IFCSURFACESTYLE": {
                    "color": "#0116a5",
                    "count": 60
                },
                "IFCPRESENTATIONSTYLEASSIGNMENT": {
                    "color": "#dc2780",
                    "count": 110
                },
                "IFCSTYLEDITEM": {
                    "color": "#026c37",
                    "count": 4755
                },
                "IFCBOUNDINGBOX": {
                    "color": "#b83f0a",
                    "count": 3131
                },
                "IFCPRODUCTDEFINITIONSHAPE": {
                    "color": "#1a6b12",
                    "count": 3829
                },
                "IFCWALLSTANDARDCASE": {
                    "color": "#975161",
                    "count": 1607
                },
                "IFCMATERIAL": {
                    "color": "#9c36ae",
                    "count": 60
                },
                "IFCSTYLEDREPRESENTATION": {
                    "color": "#30591a",
                    "count": 59
                },
                "IFCMATERIALDEFINITIONREPRESENTATION": {
                    "color": "#a440e9",
                    "count": 59
                },
                "IFCMATERIALLAYER": {
                    "color": "#2438b0",
                    "count": 37
                },
                "IFCMATERIALLAYERSET": {
                    "color": "#120034",
                    "count": 29
                },
                "IFCMATERIALLAYERSETUSAGE": {
                    "color": "#252fd8",
                    "count": 1741
                },
                "IFCWALLTYPE": {
                    "color": "#091def",
                    "count": 17
                },
                "IFCCLASSIFICATION": {
                    "color": "#29168f",
                    "count": 1
                },
                "IFCCLASSIFICATIONREFERENCE": {
                    "color": "#56124e",
                    "count": 35
                },
                "IFCRELASSOCIATESCLASSIFICATION": {
                    "color": "#3279a5",
                    "count": 35
                },
                "IFCRELFILLSELEMENT": {
                    "color": "#ca3533",
                    "count": 637
                },
                "IFCOPENINGELEMENT": {
                    "color": "#7b1533",
                    "count": 678
                },
                "IFCRELVOIDSELEMENT": {
                    "color": "#9f2ae9",
                    "count": 678
                },
                "IFCPLANE": {
                    "color": "#af5b0d",
                    "count": 43
                },
                "IFCPOLYGONALBOUNDEDHALFSPACE": {
                    "color": "#c4204b",
                    "count": 33
                },
                "IFCBOOLEANCLIPPINGRESULT": {
                    "color": "#6738f8",
                    "count": 43
                },
                "IFCPOLYLOOP": {
                    "color": "#7a4f26",
                    "count": 1583016
                },
                "IFCFACEOUTERBOUND": {
                    "color": "#2464b7",
                    "count": 1582891
                },
                "IFCFACE": {
                    "color": "#8e0a21",
                    "count": 1582891
                },
                "IFCFACEBOUND": {
                    "color": "#0260b8",
                    "count": 125
                },
                "IFCCLOSEDSHELL": {
                    "color": "#12049d",
                    "count": 2321
                },
                "IFCFACETEDBREP": {
                    "color": "#a14bc2",
                    "count": 2321
                },
                "IFCREPRESENTATIONMAP": {
                    "color": "#60317e",
                    "count": 481
                },
                "IFCDOORLININGPROPERTIES": {
                    "color": "#d3057e",
                    "count": 123
                },
                "IFCDOORPANELPROPERTIES": {
                    "color": "#5f0ea1",
                    "count": 123
                },
                "IFCDOORSTYLE": {
                    "color": "#122d27",
                    "count": 123
                },
                "IFCCARTESIANTRANSFORMATIONOPERATOR3D": {
                    "color": "#4633b3",
                    "count": 1
                },
                "IFCMAPPEDITEM": {
                    "color": "#3471b3",
                    "count": 1387
                },
                "IFCDOOR": {
                    "color": "#692f99",
                    "count": 675
                },
                "IFCMATERIALLIST": {
                    "color": "#3d7b79",
                    "count": 932
                },
                "IFCBUILDINGELEMENTPROXYTYPE": {
                    "color": "#47258f",
                    "count": 64
                },
                "IFCBUILDINGELEMENTPROXY": {
                    "color": "#306a14",
                    "count": 130
                },
                "IFCARBITRARYCLOSEDPROFILEDEF": {
                    "color": "#2e61d2",
                    "count": 434
                },
                "IFCARBITRARYPROFILEDEFWITHVOIDS": {
                    "color": "#14807e",
                    "count": 54
                },
                "IFCSLAB": {
                    "color": "#4d2a44",
                    "count": 35
                },
                "IFCSLABTYPE": {
                    "color": "#655304",
                    "count": 35
                },
                "IFCHALFSPACESOLID": {
                    "color": "#634007",
                    "count": 10
                },
                "IFCGROUP": {
                    "color": "#6a734e",
                    "count": 29
                },
                "IFCWINDOWLININGPROPERTIES": {
                    "color": "#324b29",
                    "count": 10
                },
                "IFCWINDOWSTYLE": {
                    "color": "#df2e43",
                    "count": 10
                },
                "IFCWINDOW": {
                    "color": "#5e34d5",
                    "count": 31
                },
                "IFCFURNITURETYPE": {
                    "color": "#291658",
                    "count": 4
                },
                "IFCFURNISHINGELEMENT": {
                    "color": "#5b5552",
                    "count": 16
                },
                "IFCCOMPOSITECURVESEGMENT": {
                    "color": "#286c29",
                    "count": 525
                },
                "IFCCIRCLE": {
                    "color": "#5026f4",
                    "count": 299
                },
                "IFCTRIMMEDCURVE": {
                    "color": "#5f450e",
                    "count": 299
                },
                "IFCCOMPOSITECURVE": {
                    "color": "#0d7583",
                    "count": 110
                },
                "IFCSTAIR": {
                    "color": "#881e23",
                    "count": 2
                },
                "IFCSTAIRFLIGHT": {
                    "color": "#6e4a78",
                    "count": 2
                },
                "IFCSTAIRFLIGHTTYPE": {
                    "color": "#5c11ac",
                    "count": 2
                },
                "IFCCURTAINWALL": {
                    "color": "#a34ac4",
                    "count": 144
                },
                "IFCCURTAINWALLTYPE": {
                    "color": "#10506b",
                    "count": 9
                },
                "IFCMEMBERTYPE": {
                    "color": "#690708",
                    "count": 256
                },
                "IFCMEMBER": {
                    "color": "#a900f9",
                    "count": 503
                },
                "IFCRELAGGREGATES": {
                    "color": "#003d1b",
                    "count": 44
                },
                "IFCPLATETYPE": {
                    "color": "#1e632d",
                    "count": 28
                },
                "IFCPLATE": {
                    "color": "#57094b",
                    "count": 38
                },
                "IFCCIRCLEPROFILEDEF": {
                    "color": "#bb0f59",
                    "count": 3
                },
                "IFCRAILING": {
                    "color": "#4e5ef0",
                    "count": 11
                },
                "IFCDISTRIBUTIONPORT": {
                    "color": "#0703d8",
                    "count": 3
                },
                "IFCRELCONNECTSPORTTOELEMENT": {
                    "color": "#4b3c21",
                    "count": 3
                },
                "IFCRELASSIGNSTOGROUP": {
                    "color": "#b10f5a",
                    "count": 29
                },
                "IFCRELCONTAINEDINSPATIALSTRUCTURE": {
                    "color": "#8d10a4",
                    "count": 1
                },
                "IFCRELASSOCIATESMATERIAL": {
                    "color": "#78735c",
                    "count": 2712
                },
                "IFCRELDEFINESBYTYPE": {
                    "color": "#a95292",
                    "count": 546
                },
                "IFCRELCONNECTSPATHELEMENTS": {
                    "color": "#75411d",
                    "count": 1971
                },
                "IFCPRESENTATIONLAYERASSIGNMENT": {
                    "color": "#166a12",
                    "count": 13
                }
            },
            "relations": {
                "IFCAPPLICATION": [
                    {
                        "name": "IFCORGANIZATION",
                        "count": 1
                    }
                ],
                "IFCAXIS2PLACEMENT3D": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 9232
                    },
                    {
                        "name": "IFCDIRECTION",
                        "count": 9396
                    }
                ],
                "IFCPERSONANDORGANIZATION": [
                    {
                        "name": "IFCPERSON",
                        "count": 1
                    },
                    {
                        "name": "IFCORGANIZATION",
                        "count": 1
                    }
                ],
                "IFCOWNERHISTORY": [
                    {
                        "name": "IFCPERSONANDORGANIZATION",
                        "count": 1
                    },
                    {
                        "name": "IFCAPPLICATION",
                        "count": 1
                    }
                ],
                "IFCMEASUREWITHUNIT": [
                    {
                        "name": "IFCSIUNIT",
                        "count": 1
                    }
                ],
                "IFCCONVERSIONBASEDUNIT": [
                    {
                        "name": "IFCDIMENSIONALEXPONENTS",
                        "count": 1
                    },
                    {
                        "name": "IFCMEASUREWITHUNIT",
                        "count": 1
                    }
                ],
                "IFCDERIVEDUNITELEMENT": [
                    {
                        "name": "IFCSIUNIT",
                        "count": 25
                    }
                ],
                "IFCDERIVEDUNIT": [
                    {
                        "name": "IFCDERIVEDUNITELEMENT",
                        "count": 50
                    }
                ],
                "IFCUNITASSIGNMENT": [
                    {
                        "name": "IFCSIUNIT",
                        "count": 30
                    },
                    {
                        "name": "IFCCONVERSIONBASEDUNIT",
                        "count": 2
                    },
                    {
                        "name": "IFCDERIVEDUNIT",
                        "count": 18
                    }
                ],
                "IFCGEOMETRICREPRESENTATIONCONTEXT": [
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 1
                    },
                    {
                        "name": "IFCDIRECTION",
                        "count": 1
                    }
                ],
                "IFCGEOMETRICREPRESENTATIONSUBCONTEXT": [
                    {
                        "name": "IFCGEOMETRICREPRESENTATIONCONTEXT",
                        "count": 4
                    }
                ],
                "IFCPROJECT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 1
                    },
                    {
                        "name": "IFCGEOMETRICREPRESENTATIONCONTEXT",
                        "count": 2
                    },
                    {
                        "name": "IFCUNITASSIGNMENT",
                        "count": 1
                    }
                ],
                "IFCLOCALPLACEMENT": [
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 3876
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 3274
                    }
                ],
                "IFCSITE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 1
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 1
                    }
                ],
                "IFCPROPERTYSET": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 20221
                    },
                    {
                        "name": "IFCPROPERTYSINGLEVALUE",
                        "count": 83498
                    }
                ],
                "IFCRELDEFINESBYPROPERTIES": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 18619
                    },
                    {
                        "name": "IFCSITE",
                        "count": 2
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 18619
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 22306
                    },
                    {
                        "name": "IFCOPENINGELEMENT",
                        "count": 338
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 6506
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 1350
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 402
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 270
                    },
                    {
                        "name": "IFCFURNISHINGELEMENT",
                        "count": 120
                    },
                    {
                        "name": "IFCSTAIR",
                        "count": 18
                    },
                    {
                        "name": "IFCSTAIRFLIGHT",
                        "count": 12
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 1480
                    },
                    {
                        "name": "IFCMEMBER",
                        "count": 4024
                    },
                    {
                        "name": "IFCPLATE",
                        "count": 304
                    },
                    {
                        "name": "IFCRAILING",
                        "count": 106
                    }
                ],
                "IFCPOLYLINE": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 14424
                    }
                ],
                "IFCSHAPEREPRESENTATION": [
                    {
                        "name": "IFCGEOMETRICREPRESENTATIONSUBCONTEXT",
                        "count": 9151
                    },
                    {
                        "name": "IFCPOLYLINE",
                        "count": 3252
                    },
                    {
                        "name": "IFCEXTRUDEDAREASOLID",
                        "count": 6332
                    },
                    {
                        "name": "IFCBOUNDINGBOX",
                        "count": 6262
                    },
                    {
                        "name": "IFCBOOLEANCLIPPINGRESULT",
                        "count": 46
                    },
                    {
                        "name": "IFCFACETEDBREP",
                        "count": 4642
                    },
                    {
                        "name": "IFCMAPPEDITEM",
                        "count": 2774
                    },
                    {
                        "name": "IFCTRIMMEDCURVE",
                        "count": 168
                    }
                ],
                "IFCAXIS2PLACEMENT2D": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 3000
                    },
                    {
                        "name": "IFCDIRECTION",
                        "count": 3000
                    }
                ],
                "IFCRECTANGLEPROFILEDEF": [
                    {
                        "name": "IFCAXIS2PLACEMENT2D",
                        "count": 2698
                    }
                ],
                "IFCEXTRUDEDAREASOLID": [
                    {
                        "name": "IFCRECTANGLEPROFILEDEF",
                        "count": 2698
                    },
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 3189
                    },
                    {
                        "name": "IFCDIRECTION",
                        "count": 3189
                    },
                    {
                        "name": "IFCARBITRARYCLOSEDPROFILEDEF",
                        "count": 434
                    },
                    {
                        "name": "IFCARBITRARYPROFILEDEFWITHVOIDS",
                        "count": 54
                    },
                    {
                        "name": "IFCCIRCLEPROFILEDEF",
                        "count": 3
                    }
                ],
                "IFCSURFACESTYLERENDERING": [
                    {
                        "name": "IFCCOLOURRGB",
                        "count": 60
                    }
                ],
                "IFCSURFACESTYLE": [
                    {
                        "name": "IFCSURFACESTYLERENDERING",
                        "count": 120
                    }
                ],
                "IFCPRESENTATIONSTYLEASSIGNMENT": [
                    {
                        "name": "IFCSURFACESTYLE",
                        "count": 220
                    }
                ],
                "IFCSTYLEDITEM": [
                    {
                        "name": "IFCEXTRUDEDAREASOLID",
                        "count": 2513
                    },
                    {
                        "name": "IFCPRESENTATIONSTYLEASSIGNMENT",
                        "count": 9510
                    },
                    {
                        "name": "IFCFACETEDBREP",
                        "count": 2183
                    }
                ],
                "IFCBOUNDINGBOX": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 3131
                    }
                ],
                "IFCPRODUCTDEFINITIONSHAPE": [
                    {
                        "name": "IFCSHAPEREPRESENTATION",
                        "count": 17340
                    }
                ],
                "IFCWALLSTANDARDCASE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 1607
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 1607
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 1607
                    }
                ],
                "IFCSTYLEDREPRESENTATION": [
                    {
                        "name": "IFCGEOMETRICREPRESENTATIONCONTEXT",
                        "count": 59
                    },
                    {
                        "name": "IFCSTYLEDITEM",
                        "count": 118
                    }
                ],
                "IFCMATERIALDEFINITIONREPRESENTATION": [
                    {
                        "name": "IFCSTYLEDREPRESENTATION",
                        "count": 118
                    },
                    {
                        "name": "IFCMATERIAL",
                        "count": 59
                    }
                ],
                "IFCMATERIALLAYER": [
                    {
                        "name": "IFCMATERIAL",
                        "count": 37
                    }
                ],
                "IFCMATERIALLAYERSET": [
                    {
                        "name": "IFCMATERIALLAYER",
                        "count": 74
                    }
                ],
                "IFCMATERIALLAYERSETUSAGE": [
                    {
                        "name": "IFCMATERIALLAYERSET",
                        "count": 1741
                    }
                ],
                "IFCWALLTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 17
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 166
                    }
                ],
                "IFCCLASSIFICATIONREFERENCE": [
                    {
                        "name": "IFCCLASSIFICATION",
                        "count": 35
                    }
                ],
                "IFCRELASSOCIATESCLASSIFICATION": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 35
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 3214
                    },
                    {
                        "name": "IFCOPENINGELEMENT",
                        "count": 78
                    },
                    {
                        "name": "IFCCLASSIFICATIONREFERENCE",
                        "count": 35
                    },
                    {
                        "name": "IFCDOORSTYLE",
                        "count": 222
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 1332
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 260
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 70
                    },
                    {
                        "name": "IFCWINDOWSTYLE",
                        "count": 18
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 62
                    },
                    {
                        "name": "IFCFURNITURETYPE",
                        "count": 8
                    },
                    {
                        "name": "IFCFURNISHINGELEMENT",
                        "count": 32
                    },
                    {
                        "name": "IFCSTAIR",
                        "count": 4
                    },
                    {
                        "name": "IFCSTAIRFLIGHT",
                        "count": 4
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 288
                    },
                    {
                        "name": "IFCMEMBER",
                        "count": 1006
                    },
                    {
                        "name": "IFCPLATE",
                        "count": 76
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXYTYPE",
                        "count": 106
                    },
                    {
                        "name": "IFCRAILING",
                        "count": 22
                    }
                ],
                "IFCRELFILLSELEMENT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 637
                    },
                    {
                        "name": "IFCOPENINGELEMENT",
                        "count": 637
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 606
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 31
                    }
                ],
                "IFCOPENINGELEMENT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 678
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 678
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 678
                    }
                ],
                "IFCRELVOIDSELEMENT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 678
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 678
                    },
                    {
                        "name": "IFCOPENINGELEMENT",
                        "count": 678
                    }
                ],
                "IFCPLANE": [
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 43
                    }
                ],
                "IFCPOLYGONALBOUNDEDHALFSPACE": [
                    {
                        "name": "IFCPLANE",
                        "count": 33
                    },
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 33
                    },
                    {
                        "name": "IFCPOLYLINE",
                        "count": 33
                    }
                ],
                "IFCBOOLEANCLIPPINGRESULT": [
                    {
                        "name": "IFCEXTRUDEDAREASOLID",
                        "count": 23
                    },
                    {
                        "name": "IFCPOLYGONALBOUNDEDHALFSPACE",
                        "count": 33
                    },
                    {
                        "name": "IFCHALFSPACESOLID",
                        "count": 10
                    },
                    {
                        "name": "IFCBOOLEANCLIPPINGRESULT",
                        "count": 20
                    }
                ],
                "IFCPOLYLOOP": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 10449140
                    }
                ],
                "IFCFACEOUTERBOUND": [
                    {
                        "name": "IFCPOLYLOOP",
                        "count": 1582891
                    }
                ],
                "IFCFACE": [
                    {
                        "name": "IFCFACEOUTERBOUND",
                        "count": 3165782
                    },
                    {
                        "name": "IFCFACEBOUND",
                        "count": 250
                    }
                ],
                "IFCFACEBOUND": [
                    {
                        "name": "IFCPOLYLOOP",
                        "count": 125
                    }
                ],
                "IFCCLOSEDSHELL": [
                    {
                        "name": "IFCFACE",
                        "count": 3165782
                    }
                ],
                "IFCFACETEDBREP": [
                    {
                        "name": "IFCCLOSEDSHELL",
                        "count": 2321
                    }
                ],
                "IFCREPRESENTATIONMAP": [
                    {
                        "name": "IFCAXIS2PLACEMENT3D",
                        "count": 481
                    },
                    {
                        "name": "IFCSHAPEREPRESENTATION",
                        "count": 481
                    }
                ],
                "IFCDOORLININGPROPERTIES": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 123
                    }
                ],
                "IFCDOORPANELPROPERTIES": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 123
                    }
                ],
                "IFCDOORSTYLE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 123
                    },
                    {
                        "name": "IFCDOORLININGPROPERTIES",
                        "count": 246
                    },
                    {
                        "name": "IFCDOORPANELPROPERTIES",
                        "count": 246
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 658
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 242
                    }
                ],
                "IFCCARTESIANTRANSFORMATIONOPERATOR3D": [
                    {
                        "name": "IFCCARTESIANPOINT",
                        "count": 1
                    }
                ],
                "IFCMAPPEDITEM": [
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 1387
                    },
                    {
                        "name": "IFCCARTESIANTRANSFORMATIONOPERATOR3D",
                        "count": 1387
                    }
                ],
                "IFCDOOR": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 675
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 675
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 675
                    }
                ],
                "IFCMATERIALLIST": [
                    {
                        "name": "IFCMATERIAL",
                        "count": 6070
                    }
                ],
                "IFCBUILDINGELEMENTPROXYTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 64
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 248
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 126
                    }
                ],
                "IFCBUILDINGELEMENTPROXY": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 130
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 130
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 130
                    }
                ],
                "IFCARBITRARYCLOSEDPROFILEDEF": [
                    {
                        "name": "IFCPOLYLINE",
                        "count": 326
                    },
                    {
                        "name": "IFCCOMPOSITECURVE",
                        "count": 108
                    }
                ],
                "IFCARBITRARYPROFILEDEFWITHVOIDS": [
                    {
                        "name": "IFCPOLYLINE",
                        "count": 300
                    },
                    {
                        "name": "IFCCOMPOSITECURVE",
                        "count": 2
                    }
                ],
                "IFCSLAB": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 35
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 35
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 35
                    }
                ],
                "IFCSLABTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 35
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 318
                    }
                ],
                "IFCHALFSPACESOLID": [
                    {
                        "name": "IFCPLANE",
                        "count": 10
                    }
                ],
                "IFCGROUP": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 29
                    }
                ],
                "IFCWINDOWLININGPROPERTIES": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 10
                    }
                ],
                "IFCWINDOWSTYLE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 10
                    },
                    {
                        "name": "IFCWINDOWLININGPROPERTIES",
                        "count": 20
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 54
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 20
                    }
                ],
                "IFCWINDOW": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 31
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 31
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 31
                    }
                ],
                "IFCFURNITURETYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 4
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 16
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 8
                    }
                ],
                "IFCFURNISHINGELEMENT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 16
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 16
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 16
                    }
                ],
                "IFCCOMPOSITECURVESEGMENT": [
                    {
                        "name": "IFCPOLYLINE",
                        "count": 310
                    },
                    {
                        "name": "IFCTRIMMEDCURVE",
                        "count": 215
                    }
                ],
                "IFCCIRCLE": [
                    {
                        "name": "IFCAXIS2PLACEMENT2D",
                        "count": 299
                    }
                ],
                "IFCTRIMMEDCURVE": [
                    {
                        "name": "IFCCIRCLE",
                        "count": 299
                    }
                ],
                "IFCCOMPOSITECURVE": [
                    {
                        "name": "IFCCOMPOSITECURVESEGMENT",
                        "count": 1050
                    }
                ],
                "IFCSTAIR": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 2
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 2
                    }
                ],
                "IFCSTAIRFLIGHT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 2
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 2
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 2
                    }
                ],
                "IFCSTAIRFLIGHTTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 2
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 8
                    }
                ],
                "IFCCURTAINWALL": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 144
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 144
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 103
                    }
                ],
                "IFCCURTAINWALLTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 9
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 48
                    }
                ],
                "IFCMEMBERTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 256
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 1530
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 510
                    }
                ],
                "IFCMEMBER": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 503
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 503
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 503
                    }
                ],
                "IFCRELAGGREGATES": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 44
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 247
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 46
                    },
                    {
                        "name": "IFCMEMBER",
                        "count": 1006
                    },
                    {
                        "name": "IFCPLATE",
                        "count": 76
                    },
                    {
                        "name": "IFCSTAIR",
                        "count": 2
                    },
                    {
                        "name": "IFCSTAIRFLIGHT",
                        "count": 4
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 4
                    },
                    {
                        "name": "IFCRAILING",
                        "count": 2
                    },
                    {
                        "name": "IFCPROJECT",
                        "count": 1
                    },
                    {
                        "name": "IFCSITE",
                        "count": 2
                    }
                ],
                "IFCPLATETYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 28
                    },
                    {
                        "name": "IFCPROPERTYSET",
                        "count": 158
                    },
                    {
                        "name": "IFCREPRESENTATIONMAP",
                        "count": 56
                    }
                ],
                "IFCPLATE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 38
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 38
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 38
                    }
                ],
                "IFCCIRCLEPROFILEDEF": [
                    {
                        "name": "IFCAXIS2PLACEMENT2D",
                        "count": 3
                    }
                ],
                "IFCRAILING": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 11
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 11
                    },
                    {
                        "name": "IFCPRODUCTDEFINITIONSHAPE",
                        "count": 11
                    }
                ],
                "IFCDISTRIBUTIONPORT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 3
                    },
                    {
                        "name": "IFCLOCALPLACEMENT",
                        "count": 3
                    }
                ],
                "IFCRELCONNECTSPORTTOELEMENT": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 3
                    },
                    {
                        "name": "IFCDISTRIBUTIONPORT",
                        "count": 3
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 3
                    }
                ],
                "IFCRELASSIGNSTOGROUP": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 29
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 38
                    },
                    {
                        "name": "IFCGROUP",
                        "count": 29
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 180
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 6
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 12
                    }
                ],
                "IFCRELCONTAINEDINSPATIALSTRUCTURE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 1
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 3214
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 1304
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 260
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 66
                    },
                    {
                        "name": "IFCOPENINGELEMENT",
                        "count": 8
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 62
                    },
                    {
                        "name": "IFCFURNISHINGELEMENT",
                        "count": 32
                    },
                    {
                        "name": "IFCSTAIR",
                        "count": 4
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 82
                    },
                    {
                        "name": "IFCRAILING",
                        "count": 20
                    },
                    {
                        "name": "IFCSITE",
                        "count": 1
                    }
                ],
                "IFCRELASSOCIATESMATERIAL": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 2712
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 3214
                    },
                    {
                        "name": "IFCMATERIALLAYERSETUSAGE",
                        "count": 1741
                    },
                    {
                        "name": "IFCWALLTYPE",
                        "count": 34
                    },
                    {
                        "name": "IFCMATERIALLAYERSET",
                        "count": 29
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 70
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 206
                    },
                    {
                        "name": "IFCCURTAINWALLTYPE",
                        "count": 4
                    },
                    {
                        "name": "IFCDOORSTYLE",
                        "count": 246
                    },
                    {
                        "name": "IFCMATERIAL",
                        "count": 10
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 1350
                    },
                    {
                        "name": "IFCMATERIALLIST",
                        "count": 932
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXYTYPE",
                        "count": 126
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 258
                    },
                    {
                        "name": "IFCSLABTYPE",
                        "count": 62
                    },
                    {
                        "name": "IFCSTAIRFLIGHT",
                        "count": 4
                    },
                    {
                        "name": "IFCMEMBER",
                        "count": 1006
                    },
                    {
                        "name": "IFCWINDOWSTYLE",
                        "count": 20
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 62
                    },
                    {
                        "name": "IFCFURNITURETYPE",
                        "count": 8
                    },
                    {
                        "name": "IFCFURNISHINGELEMENT",
                        "count": 32
                    },
                    {
                        "name": "IFCMEMBERTYPE",
                        "count": 510
                    },
                    {
                        "name": "IFCPLATETYPE",
                        "count": 56
                    },
                    {
                        "name": "IFCPLATE",
                        "count": 76
                    },
                    {
                        "name": "IFCRAILING",
                        "count": 4
                    }
                ],
                "IFCRELDEFINESBYTYPE": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 546
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 3214
                    },
                    {
                        "name": "IFCWALLTYPE",
                        "count": 17
                    },
                    {
                        "name": "IFCDOOR",
                        "count": 1350
                    },
                    {
                        "name": "IFCDOORSTYLE",
                        "count": 121
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXY",
                        "count": 260
                    },
                    {
                        "name": "IFCBUILDINGELEMENTPROXYTYPE",
                        "count": 64
                    },
                    {
                        "name": "IFCSLAB",
                        "count": 70
                    },
                    {
                        "name": "IFCSLABTYPE",
                        "count": 35
                    },
                    {
                        "name": "IFCWINDOW",
                        "count": 62
                    },
                    {
                        "name": "IFCWINDOWSTYLE",
                        "count": 10
                    },
                    {
                        "name": "IFCFURNISHINGELEMENT",
                        "count": 32
                    },
                    {
                        "name": "IFCFURNITURETYPE",
                        "count": 4
                    },
                    {
                        "name": "IFCSTAIRFLIGHT",
                        "count": 4
                    },
                    {
                        "name": "IFCSTAIRFLIGHTTYPE",
                        "count": 2
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 288
                    },
                    {
                        "name": "IFCCURTAINWALLTYPE",
                        "count": 9
                    },
                    {
                        "name": "IFCMEMBER",
                        "count": 1006
                    },
                    {
                        "name": "IFCMEMBERTYPE",
                        "count": 256
                    },
                    {
                        "name": "IFCPLATE",
                        "count": 76
                    },
                    {
                        "name": "IFCPLATETYPE",
                        "count": 28
                    }
                ],
                "IFCRELCONNECTSPATHELEMENTS": [
                    {
                        "name": "IFCOWNERHISTORY",
                        "count": 1971
                    },
                    {
                        "name": "IFCWALLSTANDARDCASE",
                        "count": 3925
                    },
                    {
                        "name": "IFCCURTAINWALL",
                        "count": 17
                    }
                ],
                "IFCPRESENTATIONLAYERASSIGNMENT": [
                    {
                        "name": "IFCSHAPEREPRESENTATION",
                        "count": 12036
                    }
                ]
            }
        };


        // =======================
        // Build nodes & links
        // =======================
        const nodesMap = new Map();
        if (data.nodes) {
            for (const [id, props] of Object.entries(data.nodes)) nodesMap.set(id, { id, ...(props || {}) });
        }
        function ensureNode(id) { if (!nodesMap.has(id)) nodesMap.set(id, { id }); return nodesMap.get(id); }

        const rawRelations = data.relations ?? {};
        const links = [];
        function addRelation(source, rel) {
            const target = rel.name;
            const cnt = +rel.count || 0;
            ensureNode(source); ensureNode(target);
            links.push({ source, target, label: String(cnt), countNum: cnt });
        }
        for (const [source, val] of Object.entries(rawRelations)) {
            if (Array.isArray(val)) val.forEach(r => addRelation(source, r));
            else if (val && typeof val === "object") addRelation(source, val);
        }
        const nodes = Array.from(nodesMap.values());

        // =======================
        // Scales & configuration
        // =======================
        const STORAGE_KEY = "ifc-graph-state-v1";
        const width = window.innerWidth, height = window.innerHeight;

        const maxNodeCount = d3.max(nodes, d => d.count || 0) || 1;
        const maxEdgeCount = d3.max(links, d => d.countNum || 0) || 1;

        let sizeByCount = true;
        let weightByCount = true;
        let minNodeCount = 0;
        let minEdgeCount = 0;
        let layoutMode = "force"; // "force" | "hier"
        let frozen = false;

        const rScale = d3.scaleSqrt().domain([0, maxNodeCount]).range([12, 32]);
        const edgeWScale = d3.scaleLinear().domain([0, maxEdgeCount]).range([1.5, 6]);

        // =======================
        // SVG & simulation
        // =======================
        const svg = d3.select("svg");
        const container = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([0.2, 4])
            .on("zoom", e => container.attr("transform", e.transform));

        svg.call(zoom);

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-350))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => nodeRadius(d) + 4));

        const linkSel = container.selectAll(".link")
            .data(links)
            .enter()
            .append("line")
            .attr("class", "link");

        const edgeLabelSel = container.selectAll(".edge-label")
            .data(links)
            .enter()
            .append("text")
            .attr("class", "edge-label")
            .attr("dy", -4)
            .text(d => d.label);

        const nodeSel = container.selectAll(".node")
            .data(nodes, d => d.id)
            .enter()
            .append("g")
            .attr("class", "node")
            .on("dblclick", (e, d) => { toggleUserPin(d); saveState(); })
            .call(
                d3.drag()
                    .on("start", (event, d) => {
                        if (!event.active && !frozen) simulation.alphaTarget(0.3).restart();
                        if (!isPinned(d)) { d.fx = d.x; d.fy = d.y; } // temp fix while dragging
                    })
                    .on("drag", (event, d) => {
                        d.fx = event.x; d.fy = event.y;
                        if (frozen) ticked(); // manually update while frozen
                    })
                    .on("end", (event, d) => {
                        if (!event.active && !frozen) simulation.alphaTarget(0);
                        if (!isPinned(d)) { d.fx = null; d.fy = null; } // release if not pinned
                        saveState();
                    })
            );

        const nodeCircle = nodeSel.append("circle")
            .attr("r", d => nodeRadius(d))
            .attr("fill", d => d.color || "steelblue");

        const nodeLabel = nodeSel.append("text")
            .attr("class", "node-label")
            .attr("dy", "0.1em")
            .text(d => d.id);

        const nodeCountText = nodeSel.append("text")
            .attr("class", "node-count")
            .attr("dy", "1.5em")
            .text(d => (d.count == null ? "" : `count: ${d.count}`));

        const pinIcon = nodeSel.append("text")
            .attr("class", "pin-icon")
            .text("📌");

        // Position pin icon relative to node radius
        function positionPinIcons() {
            nodeSel.each(function (d) {
                const r = nodeRadius(d);
                d3.select(this).select(".pin-icon")
                    .attr("x", r - 2)
                    .attr("y", -r + 10)
                    .classed("hidden", !isPinned(d));
            });
        }

        function ticked() {
            linkSel
                .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

            edgeLabelSel
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2);

            nodeSel.attr("transform", d => `translate(${d.x},${d.y})`);
            positionPinIcons();
        }
        simulation.on("tick", ticked);

        // =======================
        // Helpers
        // =======================
        function nodeRadius(d) {
            return sizeByCount ? (10 + rScale(d.count || 0)) : 22;
        }
        function isPinned(d) { return d.fx != null && d.fy != null; }

        function toggleUserPin(d) {
            if (d.pinMode === "user" && isPinned(d)) {
                d.fx = null; d.fy = null; d.pinMode = null;
            } else {
                d.fx = d.x; d.fy = d.y; d.pinMode = "user";
            }
            positionPinIcons();
        }

        function unpinAll() {
            nodes.forEach(d => { if (d.pinMode === "user") { d.fx = null; d.fy = null; d.pinMode = null; } });
            positionPinIcons();
        }

        function applySizes() {
            nodeCircle.attr("r", d => nodeRadius(d));
            container.selectAll(".node").each(function (d) {
                // Update collision radius function implicitly uses nodeRadius
            });
            // Update edge widths
            linkSel.attr("stroke-width", d => weightByCount ? edgeWScale(d.countNum || 0) : 2);
            positionPinIcons();
            simulation.alpha(0.12).restart();
        }

        function applyFilters() {
            // Edge visibility
            linkSel.classed("hidden", d => (d.countNum || 0) < minEdgeCount);
            edgeLabelSel.classed("hidden", d => (d.countNum || 0) < minEdgeCount);

            // Visible nodes via edges that passed filter
            const visibleNodes = new Set();
            links.forEach(l => {
                if ((l.countNum || 0) >= minEdgeCount) { visibleNodes.add(idOf(l.source)); visibleNodes.add(idOf(l.target)); }
            });

            nodeSel.classed("hidden", d => {
                const countOK = (d.count || 0) >= minNodeCount;
                const linkedOK = visibleNodes.has(d.id);
                return !(countOK || linkedOK);
            });
        }

        function idOf(x) { return typeof x === "string" ? x : x.id; }

        function fitToView(pad = 40) {
            // Compute bbox of visible nodes
            const visible = nodes.filter(n => !d3.select(nodeSel.filter(d => d === n).node()).classed("hidden"));
            const arr = visible.length ? visible : nodes;
            const minX = d3.min(arr, d => d.x), maxX = d3.max(arr, d => d.x);
            const minY = d3.min(arr, d => d.y), maxY = d3.max(arr, d => d.y);
            const w = maxX - minX + 2 * pad, h = maxY - minY + 2 * pad;
            const midX = (minX + maxX) / 2, midY = (minY + maxY) / 2;
            const svgW = svg.node().clientWidth, svgH = svg.node().clientHeight;

            const k = Math.max(0.2, Math.min(4, 0.9 * Math.min(svgW / w, svgH / h)));
            const tx = svgW / 2 - k * midX;
            const ty = svgH / 2 - k * midY;

            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(k));
        }

        // =======================
        // Hierarchical layout (ELK)
        // =======================
        const elk = new ELK();
        async function runHierLayout() {
            // Create a simple layered graph for ELK
            const elkGraph = {
                id: "root",
                layoutOptions: {
                    "elk.algorithm": "layered",
                    "elk.direction": "RIGHT",
                    "elk.spacing.nodeNode": "30",
                    "elk.layered.spacing.nodeNodeBetweenLayers": "60",
                    "elk.spacing.edgeEdge": "20"
                },
                children: nodes.map(n => ({ id: n.id, width: 140, height: 40 })),
                edges: links.map((l, i) => ({
                    id: `e${i}`, sources: [idOf(l.source)], targets: [idOf(l.target)]
                }))
            };

            const result = await elk.layout(elkGraph);

            // Pin nodes at ELK positions (as "layout" pins, distinct from user pins)
            const posById = new Map(result.children.map(c => [c.id, c]));
            nodes.forEach(n => {
                const c = posById.get(n.id);
                if (c) {
                    const x = c.x + c.width / 2, y = c.y + c.height / 2;
                    n.x = x; n.y = y; n.fx = x; n.fy = y;
                    if (n.pinMode !== "user") n.pinMode = "layout";
                }
            });

            positionPinIcons();
            ticked(); // reflect immediately
            if (!frozen) { simulation.alpha(0.001).restart(); } // tiny nudge to settle links
        }

        function clearLayoutPins() {
            nodes.forEach(n => {
                if (n.pinMode === "layout") { n.fx = null; n.fy = null; n.pinMode = null; }
            });
            positionPinIcons();
            if (!frozen) simulation.alpha(0.15).restart();
        }

        // =======================
        // State persistence
        // =======================
        function saveState() {
            const t = d3.zoomTransform(svg.node());
            const nodeState = {};
            nodes.forEach(n => {
                nodeState[n.id] = {
                    x: n.x, y: n.y, fx: n.fx, fy: n.fy, pinMode: n.pinMode || null
                };
            });
            const state = {
                layoutMode, sizeByCount, weightByCount, minNodeCount, minEdgeCount, frozen,
                transform: { k: t.k, x: t.x, y: t.y },
                nodes: nodeState
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const s = localStorage.getItem(STORAGE_KEY);
            if (!s) return;
            try {
                const st = JSON.parse(s);
                layoutMode = st.layoutMode || layoutMode;
                sizeByCount = !!st.sizeByCount;
                weightByCount = !!st.weightByCount;
                minNodeCount = +st.minNodeCount || 0;
                minEdgeCount = +st.minEdgeCount || 0;
                frozen = !!st.frozen;

                // Restore node positions/pins
                if (st.nodes) {
                    nodes.forEach(n => {
                        const ns = st.nodes[n.id];
                        if (!ns) return;
                        if (typeof ns.x === "number") n.x = ns.x;
                        if (typeof ns.y === "number") n.y = ns.y;
                        n.fx = (ns.fx == null ? null : ns.fx);
                        n.fy = (ns.fy == null ? null : ns.fy);
                        n.pinMode = ns.pinMode || null;
                    });
                    ticked();
                }

                // Restore transform
                if (st.transform) {
                    const { k, x, y } = st.transform;
                    svg.call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(k));
                }
            } catch (e) { console.warn("Failed to load state:", e); }
        }

        // =======================
        // Controls wiring
        // =======================
        const $ = sel => document.querySelector(sel);
        const layoutModeSel = $("#layoutMode");
        const sizeByCountSel = $("#sizeByCount");
        const weightByCountSel = $("#weightByCount");
        const minNodeCountSel = $("#minNodeCount");
        const minEdgeCountSel = $("#minEdgeCount");
        const minNodeCountVal = $("#minNodeCountVal");
        const minEdgeCountVal = $("#minEdgeCountVal");
        const fitBtn = $("#fitBtn");
        const freezeBtn = $("#freezeBtn");
        const unpinBtn = $("#unpinBtn");

        // Set slider ranges based on data
        minNodeCountSel.max = String(maxNodeCount);
        minEdgeCountSel.max = String(maxEdgeCount);

        // Initialize from saved state (before applying controls)
        loadState();

        // Reflect control states in UI
        layoutModeSel.value = layoutMode;
        sizeByCountSel.checked = sizeByCount;
        weightByCountSel.checked = weightByCount;
        minNodeCountSel.value = String(minNodeCount);
        minEdgeCountSel.value = String(minEdgeCount);
        minNodeCountVal.textContent = String(minNodeCount);
        minEdgeCountVal.textContent = String(minEdgeCount);
        freezeBtn.textContent = frozen ? "Unfreeze" : "Freeze";

        // Apply initial sizes/filters & layout
        applySizes();
        applyFilters();
        if (layoutMode === "hier") runHierLayout();

        // Control handlers
        layoutModeSel.addEventListener("change", async () => {
            layoutMode = layoutModeSel.value;
            if (layoutMode === "hier") {
                await runHierLayout();
            } else {
                clearLayoutPins();
            }
            saveState();
        });

        sizeByCountSel.addEventListener("change", () => {
            sizeByCount = sizeByCountSel.checked;
            applySizes(); saveState();
        });

        weightByCountSel.addEventListener("change", () => {
            weightByCount = weightByCountSel.checked;
            applySizes(); saveState();
        });

        minNodeCountSel.addEventListener("input", () => {
            minNodeCount = +minNodeCountSel.value || 0;
            minNodeCountVal.textContent = String(minNodeCount);
            applyFilters(); saveState();
        });

        minEdgeCountSel.addEventListener("input", () => {
            minEdgeCount = +minEdgeCountSel.value || 0;
            minEdgeCountVal.textContent = String(minEdgeCount);
            applyFilters(); saveState();
        });

        fitBtn.addEventListener("click", () => { fitToView(); });

        freezeBtn.addEventListener("click", () => {
            frozen = !frozen;
            if (frozen) simulation.stop();
            else simulation.restart();
            freezeBtn.textContent = frozen ? "Unfreeze" : "Freeze";
            saveState();
        });

        unpinBtn.addEventListener("click", () => { unpinAll(); saveState(); });

        // Resize handling keeps centering force current
        window.addEventListener("resize", () => {
            const w = svg.node().clientWidth, h = svg.node().clientHeight;
            simulation.force("center", d3.forceCenter(w / 2, h / 2));
            if (!frozen) simulation.alpha(0.1).restart();
        });

        // Save state on unload
        window.addEventListener("beforeunload", saveState);
    </script>
</body>
</html>